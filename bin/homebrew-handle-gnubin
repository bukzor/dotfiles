#!/bin/sh
# create a centralized "gnubin" directory from currently-linked formulas
# also handles man and info
set -eu

pattern() {
  dirname="$1"
  echo "$HOMEBREW_PREFIX/opt/*/libexec/{gnu$dirname,$dirname}/*"
}
gnu() {
  dirname="$1"
  echo "$HOMEBREW_PREFIX/libexec/gnu$dirname"
}

HOMEBREW_PREFIX="${HOMEBREW_PREFIX:-/opt/homebrew}"
# replace crappy macos userspace with homebrew "gnubin"
if ! [ -d "$HOMEBREW_PREFIX" ]; then
  echo "Please install Homebrew!" >&2
  exit 1
fi

dest="$(gnu bin)"
mkdir -p "$dest"
PATH="$(gnu bin):$PATH"
set -x
find "$HOMEBREW_PREFIX/opt" -follow -path "$(pattern bin)" |
  xargs -tr ln -sfn -t "$dest/"

dest="$(gnu man)"
mkdir -p "$dest"
MANPATH="$dest:${MANPATH:-}"

found="$(find "$HOMEBREW_PREFIX/opt" -follow -path "$HOMEBREW_PREFIX/opt/*/libexec/gnuman/*/*" -print -quit)"
if [ "$found" ]; then
    for mandir in "$HOMEBREW_PREFIX"/opt/*/libexec/gnuman/*; do
      section="$(basename "$mandir")"
      mkdir -p "$dest/$section"
      ln -sfn "$mandir"/* "$dest/$section"
    done
fi

dest="$(gnu info)"
mkdir -p "$dest"
INFOPATH="$dest:${INFOPATH:-}"
find "$HOMEBREW_PREFIX/opt" -follow -path "$(pattern info)" -print |
  xargs -tr ln -sfn -t "$dest/"

# vim:ft=bash
